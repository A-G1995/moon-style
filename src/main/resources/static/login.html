<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ورود | Moon Style</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
        /* minimal safe styles if style.css not present */
        body{font-family:sans-serif;background:#f7f7f7;margin:0}
        .container{max-width:380px;margin:8vh auto;padding:24px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
        h1{font-size:20px;margin:0 0 16px}
        .field{display:flex;flex-direction:column;margin-bottom:12px}
        label{font-size:13px;margin-bottom:6px}
        input[type="text"],input[type="password"]{padding:10px;border:1px solid #ddd;border-radius:8px}
        .actions{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px}
        .btn{width:100%;padding:10px;border:none;border-radius:8px;background:#111;color:#fff;cursor:pointer}
        .link{font-size:13px;text-decoration:none;color:#0a58ca}
        .error{color:#c62828;background:#ffebee;border:1px solid #ffcdd2;padding:8px 10px;border-radius:8px;margin-bottom:12px;display:none}
    </style>
</head>
<body>
<div id="siteHeader"></div>
<main class="container">
    <h1>ورود به حساب</h1>

    <div id="errorBox" class="error"></div>

    <form id="login-form" autocomplete="on">
        <div class="field">
            <label for="email">ایمیل</label>
            <input id="email" type="text" placeholder="example@email.com" required />
        </div>

        <div class="field">
            <label for="password">رمز عبور</label>
            <input id="password" type="password" placeholder="*******" required />
        </div>

        <div class="actions">
            <button id="loginBtn" class="btn" type="submit">ورود</button>
        </div>

        <div class="actions" style="margin-top:8px">
            <a class="link" href="/signup.html">هنوز حساب ندارید؟ ثبت‌نام</a>
        </div>
    </form>
</main>

<!-- Your app scripts (optional vendor libs) -->
<!-- <script src="/jquery.js"></script> -->

<!-- Login logic -->
<script src="/js/login.js"></script>

<!-- Fallback: minimal inline handler if /js/login.js is not ready yet -->
<script>
    (function () {
        const form = document.getElementById('login-form');
        const emailEl = document.getElementById('email');
        const passEl = document.getElementById('password');
        const errBox = document.getElementById('errorBox');

        function showError(msg){ errBox.textContent = msg; errBox.style.display = 'block'; }
        function hideError(){ errBox.style.display = 'none'; }

        if (!form) return;
        form.addEventListener('submit', async function (e) {
            // If external login.js is present, let it handle the submit.
            if (window.__loginHandlerAttached) return;
            e.preventDefault();
            hideError();

            const email = (emailEl.value || '').trim();
            const password = passEl.value || '';

            if (!email || !password) {
                showError('ایمیل و رمز عبور الزامی است.');
                return;
            }

            try {
                const res = await fetch('/user/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!res.ok) {
                    let msg = 'ورود ناموفق بود';
                    try { const j = await res.json(); if (j && j.message) msg = j.message; } catch {}
                    showError(msg);
                    return;
                }

                const data = await res.json();
                localStorage.setItem('sessionId', data.sessionId);
                localStorage.setItem('userId', String(data.userId));
                localStorage.setItem('isAdmin', String(!!data.isAdmin));

                window.location.href = data.isAdmin ? '/panel.html' : '/all-products.html';
            } catch (err) {
                console.error(err);
                showError('خطا در ارتباط با سرور');
            }
        });
    })();
</script>
<script src="/js/header.js"></script>
</body>
</html>